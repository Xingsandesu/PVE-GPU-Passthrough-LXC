#!/bin/bash

# GPU 直通配置脚本
# 交互式选择 LXC 容器并配置 GPU 直通

set -e

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 检查是否为 root 用户
if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}错误: 此脚本需要 root 权限运行${NC}"
   exit 1
fi

# 获取所有 LXC 容器
mapfile -t containers < <(pct list | awk 'NR>1 {print $1 ":" $3}')

if [ ${#containers[@]} -eq 0 ]; then
    echo -e "${RED}未找到任何 LXC 容器${NC}"
    exit 1
fi

echo -e "${BLUE}=== GPU 直通配置工具 ===${NC}"
echo -e "${YELLOW}请选择要配置 GPU 直通的容器:${NC}"
echo

# 显示容器列表
for i in "${!containers[@]}"; do
    IFS=':' read -r ctid name <<< "${containers[$i]}"
    status=$(pct status $ctid | awk '{print $2}')
    
    # 检查是否已配置
    if grep -q "/usr/share/lxc/hooks/nvidia" "/etc/pve/lxc/${ctid}.conf" 2>/dev/null; then
        configured=" ${GREEN}[已配置]${NC}"
    else
        configured=""
    fi
    
    printf "%2d) CT %s - %s (%s)%b\n" $((i+1)) "$ctid" "$name" "$status" "$configured"
done

echo
echo -e "${YELLOW}输入选项 (1-${#containers[@]}) 或 'q' 退出:${NC}"

while true; do
    read -p "> " choice
    
    if [[ "$choice" == "q" || "$choice" == "Q" ]]; then
        echo -e "${YELLOW}已取消操作${NC}"
        exit 0
    fi
    
    if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le ${#containers[@]} ]; then
        break
    else
        echo -e "${RED}无效选择，请输入 1-${#containers[@]} 或 'q'${NC}"
    fi
done

# 获取选中的容器信息
selected_index=$((choice-1))
IFS=':' read -r ctid name <<< "${containers[$selected_index]}"

echo
echo -e "${BLUE}选中容器: CT $ctid - $name${NC}"

# 检查是否已配置
if grep -q "/usr/share/lxc/hooks/nvidia" "/etc/pve/lxc/${ctid}.conf" 2>/dev/null; then
    echo -e "${YELLOW}此容器已配置 GPU 直通${NC}"
    read -p "是否重新配置? (y/N): " confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}操作已取消${NC}"
        exit 0
    fi
fi

# 确认配置
echo -e "${YELLOW}即将为容器 CT $ctid 配置 GPU 直通${NC}"
read -p "确认继续? (y/N): " confirm

if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    echo -e "${YELLOW}操作已取消${NC}"
    exit 0
fi

echo
echo -e "${BLUE}正在配置容器 CT $ctid...${NC}"

# 备份原配置文件
cp "/etc/pve/lxc/${ctid}.conf" "/etc/pve/lxc/${ctid}.conf.backup.$(date +%Y%m%d_%H%M%S)"

# 移除已存在的 GPU 配置（如果有）
sed -i '/lxc\.hook\.pre-start.*nvidia-modprobe/d' "/etc/pve/lxc/${ctid}.conf"
sed -i '/lxc\.environment.*NVIDIA_VISIBLE_DEVICES/d' "/etc/pve/lxc/${ctid}.conf"
sed -i '/lxc\.environment.*NVIDIA_DRIVER_CAPABILITIES/d' "/etc/pve/lxc/${ctid}.conf"
sed -i '/lxc\.hook\.mount.*nvidia/d' "/etc/pve/lxc/${ctid}.conf"

# 添加 GPU 直通配置
{
    echo "lxc.hook.pre-start: sh -c '[ ! -f /dev/nvidia0 ] && /usr/bin/nvidia-modprobe -c0 -u'"
    echo "lxc.environment: NVIDIA_VISIBLE_DEVICES=all"
    echo "lxc.environment: NVIDIA_DRIVER_CAPABILITIES=all"
    echo "lxc.hook.mount: /usr/share/lxc/hooks/nvidia"
} >> "/etc/pve/lxc/${ctid}.conf"

echo -e "${GREEN}✓ GPU 直通配置已添加${NC}"

# 询问是否重启容器
container_status=$(pct status $ctid | awk '{print $2}')
if [[ "$container_status" == "running" ]]; then
    echo
    read -p "容器正在运行，是否立即重启以应用配置? (y/N): " restart_confirm
    if [[ "$restart_confirm" =~ ^[Yy]$ ]]; then
        echo -e "${BLUE}正在重启容器...${NC}"
        pct reboot "$ctid"
        echo -e "${GREEN}✓ 容器已重启${NC}"
    else
        echo -e "${YELLOW}请手动重启容器以应用配置: pct reboot $ctid${NC}"
    fi
else
    echo -e "${YELLOW}容器未运行，配置将在下次启动时生效${NC}"
fi

echo
echo -e "${GREEN}=== 配置完成 ===${NC}"
echo -e "${BLUE}提示: 容器启动后可在容器内运行 'nvidia-smi' 验证 GPU 访问${NC}"